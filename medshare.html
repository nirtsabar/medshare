<!DOCTYPE html>
<html lang="he" dir="rtl"> <!-- lang="en" dir="ltr" -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-content="title"></title>
    <link rel="icon" href="https://medlookup.org/img/group_2.svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <style>
        * {
            font-size: x-large;
            text-align: center;
            box-sizing: border-box;
            /*border-color: #fff;
            border-radius: 3px;
            border-width: 1px;
            border-style: solid; */
        }

        html {
            max-width: 100%;
        }

        .app-title {
            color: #cbd9f7;
            order: 3;
            white-space: nowrap;
            min-width: fit-content;
            /* position: absolute; */
            width: fit-content;
            font-weight: bold;
        }

        #spacer {
            order: 2;
        }

        #language {
            width: fit-content;
            margin: 10px;
            background-color: #cbd9f7;
        }

        #lang-and-title {
            display: flex;
            align-items: center;
            /* Vertical center alignment */
            flex-direction: row;

        }

        #languageSelector {
            padding: 10px;
            box-sizing: border-box;
            align-items: center;
            display: flex;
            flex-wrap: wrap;
            order: 1;
            gap: 8px;
            max-width: 35%;
            min-width: 20%;
            flex-direction: row-reverse;
        }

        ::-webkit-scrollbar {
            width: 20px;
            height: 20px;
        }

        ::-webkit-scrollbar-thumb {
            background: #646b91;
            border-radius: 6px;
        }

        #medicationForm::-webkit-scrollbar {
            height: 30px;
        }

        /* For Firefox */
        #medicationForm {
            scrollbar-width: thick;
        }

        .container::-webkit-scrollbar {
            height: 30px;
            /* Adjust the height to make it thicker */
        }

        .container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .inline-block {
            float: inline-start;
            /*display: inline-block;*/
        }

        small {
            font-size: small;
        }

        muted-text {
            color: #6c757d;
        }

        .modal-body-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 90vh;
            overflow: auto;
        }

        #imageInput {
            touch-action: auto;
            /* Explicit default touch behavior for file input */
            font-size: xx-large;
            line-height: 50%;
            padding: 40px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            cursor: pointer;
        }

        #data_text {
            white-space: pre;
        }

        figure,
        menu,
        #img_menu,
        #deetails {
            border-style: solid;
            border-color: rgb(46, 43, 226);
            border-radius: 10px;
            padding: 1%;
            justify-content: center;
        }

        menu {
            touch-action: auto !important;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        canvas {
            touch-action: none;
            /* Initially prevents touch actions on canvas */
        }

        /* The thumbnail picked - shown here (details) */
        #mdlThumbCnv {
            visibility: hidden;
            position: relative;
            border: 2px solid rgb(131, 2, 156);
            cursor: move;
            top: 0;
            left: 0;
            pointer-events: all;
            box-sizing: border-box;
            /*   box-shadow: 20px 20px 50px 50px #8888888c, -20px -20px 50px 50px #88888873; */
        }

        .label-pointer {
            cursor: pointer;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #000000;
            min-height: 100vh;
            max-width: fit-content;
            max-height: 100%;
        }

        .patient-controls {
            border-radius: 6px;
            display: flex;
            flex-wrap: wrap;
            -ms-flex-align: center;
            /* min-width: fit-content; */
            max-width: fit-content;
            margin: 0;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .patient-input {
            color: white;
            display: flex;
            align-items: left;
            width: 100%;
        }

        #patientName {
            width: 100%;
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 20px;

            min-width: 300px;
        }

        .container {
            max-width: fit-content;
            margin: auto;
            background: rgb(35, 36, 36);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(252, 251, 251, 0.856);
            overflow: auto;
        }

        .container>div {
            background-color: #3e3e3f;
            padding: 0;
            font-size: 30px;
            align-items: center;
            /* Center align items vertically within the #lang-and-title container */
        }


        form {
            scrollbar-color: #adc5f7 #6366f1;
            background-color: #f9fafb;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: fit-content;
        }

        #medicationForm::-webkit-scrollbar {
            height: 60px;
        }

        /* For Firefox */
        #medicationForm {
            scrollbar-width: thick;
        }

        .table-container {
            table-layout: auto;
            width: auto;
            border-radius: 8px;
            background-color: #52d1f8;
            padding: 0.5rem;
            gap: 1px;
            align-items: center;
        }

        .table-container input {
            min-width: 4em;
            max-width: 12em;
            width: 100%;
            transition: width 0.2s ease;
            box-sizing: border-box;
        }

        .table-container th {
            white-space: nowrap;
            padding: 0.5rem;
            width: auto;
        }

        .input-group {
            display: flex;
        }

        input,
        select,
        textarea {
            width: 4em;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 20px;
            align-items: center;
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            margin: 6px;
            border: 1px solid #020f83;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.486);
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #3b82f6;
            height: 100%;
        }

        .btn-add {
            background-color: #029e0f;
            border-radius: 20px;
            margin-top: 8px;
        }

        .btn-delete {
            background-color: #757474;
            padding: 6px;
        }

        .btn-open {
            background-color: #6366f1;
        }

        .btn-save {
            background-color: #10b981;
        }

        .export-button {
            background-color: #037c30;
        }

        .paste-button {
            background-color: #8B5CF6;
        }

        .btn-confirm-paste {
            background-color: #8B5CF6;
        }

        .btn-lookup {
            background-color: #594b8b;
            padding: 6px;
        }

        .btn-lookup:hover {
            background-color: #475569;
        }

        button:hover {
            opacity: 0.9;
        }

        table {
            border-collapse: collapse;
            background: white;
            flex: left;
            align-items: center;
        }

        .timing {
            width: 90px;
        }

        .medName {
            width: 120px;
        }

        .dose {
            width: 50px;
        }

        .quantity {
            width: 60px;
        }

        .note {
            width: 50px;
        }

        .info {
            width: 30px;
        }

        .imager {
            width: 40px;
        }

        .action {
            width: 40px;
        }

        .select option {
            text-align-last: right;
        }

        .selected-text {
            text-align: right;
        }

        .left-align {
            text-align: left;
        }

        .right-align {
            text-align: right;
        }

        th,
        td {
            background-color: #d8e5f8;
            border: 1px solid #ddd;
            margin: auto;
            padding: 3px;
            width: fit-content;
        }

        th {
            background-color: #f9fafb;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .med-image {
            width: 100px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 96%;
            display: flex;
            flex-direction: column;
            gap: 10px;

        }

        .modal-buttons {
            height: 60px;
            display: flex;
            justify-content: space-around;
            vertical-align: middle;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-cancel {
            background-color: #4b638b;
        }

        .btn-confirm-delete {
            background-color: #ef4444;
        }

        .sorting-icon {
            cursor: pointer;
            vertical-align: middle;
            margin-left: 5px;
        }

        .paste-area {
            width: 100%;
            min-height: 200px;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }

        /* Specific styles for img_handler modal */
        #img_handler_modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #img_handler_modal .modal-content {
            background-color: white;
            padding: 7px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            /*            width: 95%; /* for smartphone screen */
            text-align: center;
        }

        #img_handler_modal .modal-buttons {
            /*             display: flex;
            justify-content: center; */
            height: 100px;
            gap: 10px;
            margin-top: 20px;
        }

        #img_handler_modal button {
            height: 60px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #img_handler_modal .modal-buttons .btn-cancel {
            background-color: #324464;
        }

        #img_handler_modal .modal-buttons .btn-confirm {
            background-color: #3b82f6;
            color: white;
        }

        [contenteditable="true"] {
            padding: 5px;
            border: 1px solid;
            /* transparent */
            transition: border-color 0.2s;
        }

        [contenteditable="true"]:hover {
            border-color: #ddd;
            background-color: #f8f8f8;
        }

        [contenteditable="true"]:focus {
            outline: none;
            border-color: #b1c4e2;
            background-color: #fff;
        }
    </style>
</head>

<body>
    <!-- MARK: Body -->
    <div id="lang-and-title" data-title="xplainAppT">
        <span data-content="title" class="app-title"></span>
        <span id="spacer" style="height: 5px;"></span>
        <span id="languageSelector" data-title="languageT">
            <select id="language" onchange="handleLanguageChange(event)" class="inline-block"
                aria-labelledby="languageSelector">
                <option value="en">English</option>
                <!--                 <option value="es">EspaÃ±ol</option>
                <option value="fr">FranÃ§ais</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option> -->
                <option value="he">×¢×‘×¨×™×ª</option>
            </select>
        </span>

    </div>

    <!-- Patient name and info-control buttons   -->
    <div class="container">
        <div class="patient-controls">
            <div class="patient-input">
                <!-- 'user' svg icon--><!-- From Feather Icons (MIT) -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <input type="text" id="patientName" data-placeholder="patientNamePH" data-title="patientNameT" required>
            </div>
            <div class="pt-btn">
                <button class="btn-open" onclick="openPatientData()">
                    <!-- From Feather Icons (MIT) -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-content="open"></span>
                </button>
                <button class="btn-save" onclick="savePatientData()">
                    <!-- From Feather Icons (MIT) -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    <span data-content="save"></span>
                </button>
                <button class="export-button" onclick="exportViaWhatsApp()">
                    <!-- From Feather Icons (MIT) -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    <span data-content="export"></span>
                </button>
                <button class="paste-button" onclick="showPasteModal()">
                    <!-- From Feather Icons (MIT) -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    </svg>
                    <span data-content="paste"></span>
                </button>
            </div>
        </div>
        <!-- Medications table   -->
        <div class="scroll-wrapper" style="overflow-x: auto">
            <form id="medicationForm">
                <table id="medicationTable" class="table-container">
                    <tr id="tHeader">
                        <th id="timing_header" onclick="sortTable()" class="timing">
                            <label for="timing_header" class="label-select" data-title="timingT">
                                <!-- From Feather Icons (MIT) -->
                                <svg width="50" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <br><span data-content="timing"></span>
                            </label>
                        </th>
                        <th id="medName_header" class="medName" data-title="medicineNameT">
                            <label for="medicineName"> <!-- Sticker svg as label -->
                                <svg height="24" viewBox="0 0 400 120">
                                    <!-- Main sticker body -->
                                    <path
                                        d="M20,10 Q10,10 10,20 L10,100 Q10,110 20,110 L360,110 Q370,110 370,100 L370,70 L310,10 L20,10"
                                        fill="white" stroke="black" stroke-width="8" />
                                    <!-- Peeled corner -->
                                    <path d="M310,10 L370,70 L320,70 Q310,70 310,60 L310,10 Z" fill="gray"
                                        stroke="black" stroke-width="5" />
                                    <!-- Added text element. Note that x attribute may change in handleLanguageChange() -->
                                    <text id="t-text" x="240" y="80" font-family="Arial" style="font-size: 64px;"
                                        fill="black" data-content="medicineName1"></text>
                                </svg>
                                <br><span data-content="medicineName2"></span>
                            </label>
                        </th>
                        <th id="dose_header" class="dose">
                            <svg height="24" viewBox="0 0 80 25">
                                <circle cx="25" cy="18" r="5" stroke="black" fill="none" stroke-width="2" />
                                <circle cx="45" cy="12" r="10" stroke="black" fill="none" stroke-width="2" />
                            </svg>
                            <br><span data-content="dose"></span>
                        </th>
                        <th id="quantity_header" class="quantity">
                            <!-- From Feather Icons (MIT) -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 22A10 10 0 0 0 12 12v10z"></path>
                            </svg>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                <path d="M21 12c0 1.7-4 3-9 3s-9-1.3-9-3"></path>
                                <path d="M3 5v14c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
                            </svg>
                            <br><span data-content="quantity"></span>
                        </th>
                        <th id="note_header" class="note">
                            <svg width="24" height="24" viewBox="0 0 24 24"> <!-- exclamation mark icon  -->
                                <path d="M12 2 A2.3 2.3 0 0 1 14.3 4.3 L14.3 15 A2.3 2.3 0 0 1 12 17.3
                                        A2.3 2.3 0 0 1 9.7 15 L9.7 4.3 A2.3 2.3 0 0 1 12 2 M12 18.3
                                        A2.3 2.3 0 0 1 14.3 20.6 A2.3 2.3 0 0 1 12 22.9 A2.3 2.3 0 0 1 9.7 20.6
                                        A2.3 2.3 0 0 1 12 18.3 Z" stroke="black" stroke-width="2" fill="none" />
                            </svg>
                            <br><span data-content="note"></span>
                        </th>
                        <th id="info_header" class="info">
                            <!-- From Feather Icons (MIT) -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <br><data-content="info"></span>
                        </th>
                        <th id="pic_header" class="imager">
                            <svg width="94" height="24" viewBox="38 53 124 100"><!--camera icon-->
                                <rect x="40" y="60" width="120" height="80" rx="10" fill="white" stroke="black"
                                    stroke-width="8" />
                                <circle cx="100" cy="100" r="30" fill="white" stroke="black" stroke-width="4" />
                                <circle cx="100" cy="100" r="20" fill="white" stroke="black" stroke-width="4" />
                                <rect x="140" y="70" width="20" height="15" fill="black" />
                            </svg>
                            <br><span data-content="picture"></span>
                        </th>
                        <th id="action_header" class="action" data-content="action">Action ×¤×¢×•×œ×”</th>
                    </tr>
                    <!--  Input Row of the form  -->
                    <tr id="tInputForm">
                        <th class="timing">
                            <select name="timing" id="timingSelect" data-title="timingInstructions" required>
                                <option value="">ğŸ•“</option>
                            </select>
                        </th>
                        <th class="medName">
                            <input id="medicineName" type="text" name="medicineName" data-title="medicineNameT"
                                required>
                        </th>
                        <th class="dose"><input type="text" name="dose" data-placeholder="dosePH"></th>
                        <th class="quantity"><input type="number" name="quantity" step="0.25"
                            data-placeholder="QuantityPH" min="0">
                        </th>
                        <th class="note"><input type="text" name="note" placeholder="Note ×”×¢×¨×”"></th>
                        <th class="info">
                            <button class="btn-lookup" type="button" onclick="openMedLookup(medicineName.value)">
                                <svg data-name="Group 2" width="40" height="50" viewBox="0 0 141.721 192.336">
                                    <defs>
                                        <linearGradient id="a" x1="-.479" y1="-.773" x2="1.267" y2="2.029"
                                            gradientUnits="objectBoundingBox">
                                            <stop offset="0" stop-color="#fdf6fe" />
                                            <stop offset="1" stop-color="#7151cb" />
                                        </linearGradient>
                                    </defs>
                                    <path data-name="Path 3"
                                        d="M25.246 174.09A20.305 20.305 0 0 0 5 194.336h141.721a20.305 20.305 0 0 0-20.246-20.246H85.983v-20.246h30.369A20.305 20.305 0 0 0 136.6 133.6H55.615a30.3 30.3 0 0 1-15.488-56.387 24.823 24.823 0 0 0 18.525 10.73 25.178 25.178 0 0 0 18.727-6.276l5.973 16.3 9.516-3.442 3.442 9.516 19.031-6.884-3.441-9.517 9.516-3.442L93.677 8.074l-9.516 3.442L80.72 2 61.688 8.884 65.13 18.4l-9.516 3.543 5.669 15.691a25.143 25.143 0 0 0-25.1 18.829 50.635 50.635 0 0 0 19.436 97.383v20.244zm59.32-146.58 17.31 47.578-9.516 3.442-17.309-47.578zm-23.89 25.1a10.123 10.123 0 1 1-10.123 10.128 10.153 10.153 0 0 1 10.123-10.123z"
                                        transform="translate(-5 -2)" style="fill:url(#a)" />
                                </svg>
                            </button>
                        </th>
                        <th class="imager">
                            <label for="take_pic" class="label-pointer">
                                <!--      <i data-feather="camera"></i>-->
                                <button id="take_pic" style="background:none;" type="button"
                                    onclick="img_handler(true)">

                                    <canvas id="formThumbCnv" name="thumb" width="100" height="50"
                                        style="border:1px solid grey">
                                    </canvas>
                            </label> </button>
                            <!-- <input type="file" id="picture" name="picture" style="display:none" onchange="thumbnailing(event)"
                    accept="image/*"> -->
                        </th>
                        <th class="action"><button type="submit" class="btn-add">
                                <i data-feather="check"></i><!-- From Feather Icons (MIT) -->
                            </button></th>
                    </tr id="tInputForm">
                    <!-- Data rows will be added here via the script -->
                </table>
            </form>
        </div>

    </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Confirm Delete</h2>
            <p>Are you sure you want to delete this medication?</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeDeleteModal()">
                    <i data-feather="x"></i><!-- From Feather Icons (MIT) -->
                    Cancel
                </button>
                <button class="btn-confirm-delete" id="confirmDelete">
                    <i data-feather="trash-2"></i><!-- From Feather Icons (MIT) -->
                    Delete
                </button>
            </div>
        </div>
    </div>

    <div id="pasteModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Paste Medication Data</h2>
            <p>Paste the exportd medication data below:</p>
            <textarea id="pasteArea" class="paste-area" rows="10"
                placeholder="Paste medication schedule here..."></textarea>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closePasteModal()">
                    <i data-feather="x"></i><!-- From Feather Icons (MIT) -->
                    Cancel
                </button>
                <button class="btn-confirm-paste" onclick="processePastedData()">
                    <i data-feather="check"></i><!-- From Feather Icons (MIT) -->
                    Import
                </button>
            </div>
        </div>
    </div>

    <div id="img_handler_modal" class="modal">
        <div class="modal-content">
            <header>
                <h2 style="margin-top: 0;" data-content="TakingMedicationPicture">Taking Medication Picture</h2>
            </header>

            <div class="modal-body-vertical">
                <menu id="img_menu" class="modal-buttons">
                    <button class="btn-cancel" onclick="closeImgHandlerModal()">
                        <i data-feather="x"></i><!-- From Feather Icons (MIT) -->
                    </button>
                    <button onclick="document.getElementById('imageInput').click()"
                        style="padding: 10px; border-radius: 8px; border: none; cursor: pointer;">
                        <svg viewBox="0 0 200 200" width="100" height="100"><!--camera icon-->
                            <rect x="40" y="60" width="120" height="80" rx="10" fill="#3b82f6" stroke="white"
                                stroke-width="4" />
                            <circle cx="100" cy="100" r="30" fill="#3b82f6" stroke="white" stroke-width="4" />
                            <circle cx="100" cy="100" r="20" fill="#3b82f6" stroke="white" stroke-width="4" />
                            <rect x="140" y="70" width="20" height="15" fill="white" />
                        </svg>
                    </button>
                    <button id="frame_to_thumb" style="padding: 20px;"> <!--onclick="frame_to_thumb()"-->
                        <i data-feather="airplay"></i><!-- From Feather Icons (MIT) -->
                    </button>
                    <button id="ok_thumb" class="btn-confirm" style="padding: 20px;">
                        <i data-feather="check-circle"></i><!-- From Feather Icons (MIT) -->
                    </button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </menu>
                <div style="padding: none; overflow-y: auto;">
                    <figure style="margin:1px;">
                        <canvas id="mdlCanvas" alt="Medication Picture"></canvas>
                    </figure>
                    <div id="deetails"> <!--details for the thumbnail-->
                        <p id="data_text"></p>
                        <p><canvas id="mdlThumbCnv"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    // MARK: Translation Constants
    /* #region main script !!!*/
    /* #region initializations*/
    // Initialize Feather icons
    feather.replace();
    let medications = [];
    const medicationForm = document.getElementById('medicationForm');
    const medicationTable = document.getElementById('medicationTable');
    const patientNameInput = document.getElementById('patientName');
    const pasteModal = document.getElementById('pasteModal');
    const pasteArea = document.getElementById('pasteArea');
    const formThumbCnv = document.getElementById('formThumbCnv');
    const formThumbCtx = formThumbCnv.getContext("2d");
    formThumbCnv.clientWidth = "100px";
    formThumbCnv.clientHeight = "50px";

    // Define timing order
    const timingOrder = {
        'As_needed': 0,
        'Morning': 1,
        'Noon': 2,
        'Evening': 3
    };
    /* #endregion initializations */
    /* #region major table / form functions */
    // Update table with medications
    function updateTable() {
        // deleting old table data, from last data row to first data row
        for (var i = medicationTable.rows.length - 1; i > 1; i--) {
            medicationTable.deleteRow(i);
        }
        const tbody = medicationTable.querySelector('tbody');
        // re-sorting and re-building the html data table rows
        medications
            .sort((a, b) => timingOrder[a.timing] - timingOrder[b.timing])
            .forEach(med => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td contenteditable="true" onblur="updateCell(${med.id}, 'timing', this.textContent)">${med.timing}</td>
                    <td contenteditable="true" onblur="updateCell(${med.id}, 'medicineName', this.textContent)">${med.medicineName}</td>
                    <td contenteditable="true" onblur="updateCell(${med.id}, 'dose', this.textContent)">${med.dose}</td>
                    <td contenteditable="true" onblur="updateCell(${med.id}, 'quantity', this.textContent)">${med.quantity}</td>
                    <td contenteditable="true" onblur="updateCell(${med.id}, 'note', this.textContent)">${med.note}</td>
                    <td>
                        <button class="btn-lookup" type="button" onclick="openMedLookup('${med.medicineName}')">
                            <i data-feather="clipboard"></i>
                        </button>
                    </td>
                    <td>${med.thumb ? `<img src="${med.thumb}" class="med-image" style="width:${formThumbCnv.clientWidth}px; height:${formThumbCnv.clientHeight}px" alt="${med.medicineName}">` : ''}</td>
                    <td>
                        <button class="btn-delete" onclick="showDeleteModal(${med.id}, '${med.medicineName}')">
                            <i data-feather="trash-2"></i>
                        </button>
                    </td>
                `;
                /* new debug alert 
                alert('med.picture ='+med.picture);		*/
                tbody.appendChild(tr);
            });

        feather.replace();
    }

    // Function to open MedLookup
    function openMedLookup(medicineName) {
        const url = `https://medlookup.org/he/index.html#${encodeURIComponent(medicineName)}`;
        localStorage.setItem("freeze_mode", "freeze");
        window.open(url, '_blank');
    }

    // Update cell content
    function updateCell(id, field, value) {
        const medication = medications.find(med => med.id === id);
        if (!medication) return;

        if (field === 'timing') {
            if (!Object.keys(timingOrder).includes(value)) {
                alert('Invalid timing value. Please use: As_needed, Morning, Noon, or Evening');
                updateTable();
                return;
            }
        }

        if (field === 'quantity') {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                alert('Please enter a valid number for quantity');
                updateTable();
                return;
            }
            value = numValue;
        }

        medication[field] = value;

        if (field === 'timing') {
            sortTable();
        }

        saveCurrentState();
    }

    // Sort function
    function sortTable() {
        medications.sort((a, b) => {
            return timingOrder[a.timing] - timingOrder[b.timing];
        });
        updateTable();
        saveCurrentState();
    }

    // Handle form submission
    medicationForm.addEventListener('submit', function (e) {
        e.preventDefault();
        if (!patientNameInput.value.trim()) {
            alert('Please enter patient name first');
            return;
        }
        const formData = new FormData(this);
        const picDataUrl = document.getElementById('formThumbCnv').toDataURL();
        if (picDataUrl.length > 0) {
            addMedication(formData, picDataUrl);
        } else {
            addMedication(formData, null);
        }
    });

    // MARK: Add Medication
    function addMedication(formData, picDataUrl) {
        const newPic = new Image();
        newPic
        const medication = {
            id: Date.now(),
            timing: formData.get('timing'),
            medicineName: formData.get('medicineName'),
            dose: formData.get('dose'),
            quantity: formData.get('quantity'),
            note: formData.get('note'),
            thumb: picDataUrl
        };
        const frmCnv = document.getElementById('formThumbCnv');
        const frmCtx = frmCnv.getContext('2d');
        /*         frmCnv.width=frame.width+"px";
                frmCnv.height=frame.height+"px"; */
        medications.push(medication);
        medicationForm.reset();
        frmCtx.clearRect(0, 0, frmCnv.width, frmCnv.height);
        updateTable();
        saveCurrentState();
    }

    // MARK: Export via WhatsApp
    function exportViaWhatsApp() {
        const patientName = patientNameInput.value.trim();
        if (!patientName) {
            alert('Please enter patient name first');
            return;
        }

        let message = `Medication Schedule for ${patientName}:\n\n`;

        const groupedMeds = medications.reduce((acc, med) => {
            if (!acc[med.timing]) {
                acc[med.timing] = [];
            }
            acc[med.timing].push(med);
            return acc;
        }, {});

        Object.keys(groupedMeds)
            .sort((a, b) => timingOrder[a] - timingOrder[b])
            .forEach(timing => {
                message += `${timing}:\n`;
                groupedMeds[timing].forEach(med => {
                    message += `- ${med.medicineName}`;
                    if (med.dose) message += ` (${med.dose})`;
                    if (med.quantity) message += ` - ${med.quantity} units`;
                    if (med.note) message += ` - Note: ${med.note}`;
                    message += '\n';
                });
                message += '\n';
            });

        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
    }

    // Paste functionality
    function showPasteModal() {
        pasteModal.style.display = 'block';
        pasteArea.value = '';
        feather.replace();
    }

    function closePasteModal() {
        pasteModal.style.display = 'none';
    }

    function processePastedData() {
        const pastedText = pasteArea.value.trim();
        if (!pastedText) {
            alert('Please paste medication data first');
            return;
        }

        try {
            const lines = pastedText.split('\n');
            let currentTiming = '';
            let newMedications = [];
            let patientName = '';

            if (lines[0].startsWith('Medication Schedule for')) {
                patientName = lines[0].replace('Medication Schedule for', '').trim().replace(':', '');
                patientNameInput.value = patientName;
            }

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (Object.keys(timingOrder).includes(line.replace(':', ''))) {
                    currentTiming = line.replace(':', '');
                }
                else if (line.startsWith('-')) {
                    const medInfo = line.substring(1).trim();
                    const medication = {
                        id: Date.now() + Math.random(),
                        timing: currentTiming,
                        medicineName: '',
                        dose: '',
                        quantity: '',
                        note: '',
                        picture: null
                    };

                    let parts = medInfo.split(' - ');

                    let nameAndDose = parts[0].split(' (');
                    medication.medicineName = nameAndDose[0].trim();
                    if (nameAndDose[1]) {
                        medication.dose = nameAndDose[1].replace(')', '').trim();
                    }

                    parts.slice(1).forEach(part => {
                        if (part.toLowerCase().startsWith('note:')) {
                            medication.note = part.substring(5).trim();
                        } else if (part.includes('units')) {
                            medication.quantity = part.replace('units', '').trim();
                        }
                    });

                    newMedications.push(medication);
                }
            });

            if (newMedications.length > 0) {
                medications = newMedications;
                updateTable();
                saveCurrentState();
                closePasteModal();
                alert('Medication data imported successfully');
            } else {
                alert('No valid medication data found in the pasted text');
            }
        } catch (error) {
            alert('Error processing pasted data. Please make sure the format is correct.');
            console.error('Error processing pasted data:', error);
        }
    }

    // Delete confirmation modal functionality
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    let medicationToDelete = null;

    function showDeleteModal(id, medicineName) {
        medicationToDelete = id;
        deleteModal.style.display = 'block';
        const message = deleteModal.querySelector('p');
        message.textContent = `${t(`deleteMedication`)}${medicineName}?`;
        feather.replace();
    }

    function closeDeleteModal() {
        deleteModal.style.display = 'none';
        medicationToDelete = null;
    }

    confirmDeleteBtn.addEventListener('click', function () {
        if (medicationToDelete !== null) {
            medications = medications.filter(med => med.id !== medicationToDelete);
            updateTable();
            closeDeleteModal();
            saveCurrentState();
        }
    });

    // Save patient data
    function savePatientData() {
        const patientName = patientNameInput.value.trim();
        if (!patientName) {
            alert('Please enter patient name');
            return;
        }
        saveCurrentState();
        alert(`Medication data saved for patient: ${patientName}`);
    }

    // Open patient data
    function openPatientData() {
        const patientName = patientNameInput.value.trim();
        if (!patientName) {
            alert('Please enter patient name');
            return;
        }

        const savedData = localStorage.getItem(`patient_${patientName}`);
        if (savedData) {
            medications = JSON.parse(savedData);
            updateTable();
            alert(`Loaded medication data for patient: ${patientName}`);
        } else {
            alert(`No saved data found for patient: ${patientName}`);
            medications = [];
            updateTable();
        }
    }

    // Helper function to save current state
    function saveCurrentState() {
        const patientName = patientNameInput.value.trim();
        if (patientName) {
            try {
                localStorage.setItem(`patient_${patientName}`, JSON.stringify(medications));
            }
            catch (err) {
                if (err.message === "Failed to execute 'setItem' on 'Storage': Setting the value of 'patient_e' exceeded the quota") { }
                alert(t(`errorQuotaExceeded`) + patientName);
            }
        }
    }

    // Close modal if clicking outside
    window.onclick = function (event) {
        if (event.target === deleteModal) {
            closeDeleteModal();
        }
        if (event.target === pasteModal) {
            closePasteModal();
        }
    }
    // Switch to Thumbnail if QuotaExceededError (just idea...)
    /* #endregion major table / form functions */
    /* #endregion main script */
    /* #region Translation */
    const translations = {
        en: {
            action: 'Action',
            cancel: 'Cancel',
            confirmDelete: 'Confirm Delete',
            confirmDeleteMedication: 'Confirm Delete Medication',
            delete: 'Delete',
            deleteMedication: 'Are you sure you want to delete',
            dose: 'Dose',
            doseT: 'Medication dose  of 1 tablet in mg, syrup in ml etc. (optional)',
            dosePH: 'Dose in mg, ml etc.',
            errorProcessingPastedData: 'Error processing pasted data. Please make sure the format is correct',
            errorQuotaExceeded: 'Quota exceeded. Error saving data for ',
            export: 'Export',
            exportT: 'Exports medications list to WhatsApp',
            import: 'Import',
            importMedicationData: 'Import Medication Data',
            info: 'Leaflet',
            infoT: 'Medication information leaflet lookup',
            invalidQuantity: 'Please enter a valid number for quantity',
            invalidTiming: 'Invalid timing value. Please use: As_needed, Morning, Noon, or Evening',
            languageT: 'Choose Language',
            loadedMedicationData: 'Loaded medication data for patient:',
            medicationDataImported: 'Medication data imported successfully',
            medicationDataSaved: 'Medication data saved for patient:',
            medicationScheduleFor: 'Medication Schedule for',
            medicineName: 'Medicine Name',
            medicineName1: 'Medicine',
            medicineName2: 'Name',
            medicineNameT: 'Name of the medication (required)',
            morningShort: 'AM',
            noon: 'Noon',
            eveningShort: 'PM',
            noSavedDataFound: 'No saved data found for patient:',
            note: 'Note',
            noValidMedicationData: 'No valid medication data found in the pasted text',
            open: 'Open',
            openT: 'Opens medications list from local storage (cookies)',
            paste: 'Paste',
            pastedTextA: 'Please paste medication data first',
            pasteMedicationData: 'Paste Medication Data',
            pasteT: 'Pastes medications list from clipboard',
            patientName: 'Patient Name',
            patientNameA: 'Please enter patient name',
            patientNamePH: 'Private and Family Name',
            patientNameRequired: 'Please enter patient name',
            patientNameT: 'Name of the patient',
            pictueT: 'Medication picture. (optional)',
            picture: 'Picture',
            quantity: 'Quantity',
            quantityA: 'Please enter a valid number for quantity (eg. 0.25, 1, 1.5, 4)',
            quantityA: 'Please enter a valid number for quantity',
            quantityT: 'Number of medication units to take each time. (optional)',
            save: 'Save',
            saveT: 'Saves name and medications list to local storage (cookies)',
            timing: 'Timing',
            As_needed: 'ğŸš¨ As needed',
            Morning: 'ğŸ“ Morning',
            Noon: 'â˜€ï¸ Noon',
            Evening: 'ğŸŒ™ Evening',
            timingA: 'Please select medication intake time',
            timingOrderA: 'Invalid timing value. Please use: As_needed, Morning, Noon, or Evening',
            timingT: 'When is the medication taken?',
            title: 'Medication list of',
            xplainAppT: 'Medication list manager for patients',
        },
        he: {
            action: '×¢×•×œ×”',
            cancel: '×‘×™×˜×•×œ',
            confirmDelete: '××©×¨ ××—×™×§×”',
            confirmDeleteMedication: '××©×¨ ××—×™×§×ª ×ª×¨×•×¤×”',
            delete: '××—×§',
            deleteMedication: '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§',
            dose: '××™× ×•×Ÿ',
            doseT: '××™× ×•×Ÿ ×”×ª×¨×•×¤×” ×©×œ ×˜×‘×œ×™×” ××—×ª ×‘×"×’, ×¡×™×¨×•×¤ ×‘×"×œ ×•×›×•\' (××•×¤×¦×™×•× ×œ×™)',
            dosePH: '××™× ×•×Ÿ ×‘××’, ××œ ×•×›×“',
            errorProcessingPastedData: '×©×’×™××” ×‘×¢×™×‘×•×“ ×”× ×ª×•× ×™× ×©×”×•×“×‘×§×•. ×× × ×•×“× ×©×”×¤×•×¨××˜ × ×›×•×Ÿ',
            errorQuotaExceeded: '×—×¨×™×’×” ××”××›×¡×”. ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™× ×¢×‘×•×¨ ',
            export: '×™×¦×•×',
            exportT: '××™×™×¦× ××ª ×¨×©×™××ª ×”×ª×¨×•×¤×•×ª ×œ-WhatsApp',
            import: '×™×™×‘×',
            importMedicationData: '×™×™×‘× × ×ª×•× ×™ ×ª×¨×•×¤×•×ª',
            info: '×¢×œ×•×Ÿ',
            infoT: '×—×™×¤×•×© ×¢×œ×•×Ÿ ××™×“×¢ ×¢×œ ×”×ª×¨×•×¤×”',
            invalidQuantity: '×× × ×”×›× ×¡ ××¡×¤×¨ ×—×•×§×™ ×œ×›××•×ª',
            invalidTiming: '×¢×¨×š ×–××Ÿ ×œ× ×—×•×§×™. ×× × ×”×©×ª××©: ×œ×¤×™ ×”×¦×•×¨×š, ×‘×•×§×¨, ×¦×”×¨×™×™× ××• ×¢×¨×‘',
            languageT: '×œ×‘×—×™×¨×ª ×©×¤×”',
            loadedMedicationData: '× ×ª×•× ×™ ×”×ª×¨×•×¤×•×ª × ×˜×¢× ×• ×¢×‘×•×¨ ×”××˜×•×¤×œ:',
            medicationDataImported: '× ×ª×•× ×™ ×”×ª×¨×•×¤×•×ª ×™×•×‘××• ×‘×”×¦×œ×—×”',
            medicationDataSaved: '× ×ª×•× ×™ ×”×ª×¨×•×¤×•×ª × ×©××¨×• ×¢×‘×•×¨ ×”××˜×•×¤×œ:',
            medicationScheduleFor: '×ª×›× ×™×ª ×ª×¨×•×¤×•×ª ×¢×‘×•×¨',
            medicineName: '×©× ×ª×¨×•×¤×”',
            medicineName1: '×©×',
            medicineName2: '×”×ª×¨×•×¤×”',
            medicineNameT: '×©× ×”×ª×¨×•×¤×” (× ×“×¨×©)',
            morningShort: '×‘×§×¨',
            noon: '×¦×”×¨×™×',
            eveningShort: '×¢×¨×‘',
            noSavedDataFound: '×œ× × ××¦××• × ×ª×•× ×™× ×©××•×¨×™× ×¢×‘×•×¨ ×”××˜×•×¤×œ:',
            note: '×”×¢×¨×”',
            noValidMedicationData: '×œ× × ××¦××• × ×ª×•× ×™ ×ª×¨×•×¤×•×ª ×—×•×§×™×™× ×‘×˜×§×¡×˜ ×©×”×•×“×‘×§',
            open: '×¤×ª×—',
            openT: '×¤×•×ª×— ××ª ×¨×©×™××ª ×”×ª×¨×•×¤×•×ª ××”××—×¡×•×Ÿ ×”××§×•××™ (×¢×•×’×™×•×ª)',
            paste: '×”×“×‘×§',
            pastedTextA: '×× × ×œ×”×“×‘×™×§ ×ª×—×™×œ×” × ×ª×•× ×™ ×ª×¨×•×¤×•×ª',
            pasteMedicationData: '×”×“×‘×§ × ×ª×•× ×™ ×ª×¨×•×¤×•×ª',
            pasteT: '××“×‘×™×§ ××ª ×¨×©×™××ª ×”×ª×¨×•×¤×•×ª ××”×œ×•×—',
            patientName: '×©× ×”××˜×•×¤×œ',
            patientNameA: '×× × ×œ×”×›× ×™×¡ ×›×¢×ª ×©× ××˜×•×¤×œ',
            patientNamePH: '×©× ×¤×¨×˜×™   ×©× ××©×¤×—×”',
            patientNameRequired: '×× × ×”×›× ×¡ ×©× ××˜×•×¤×œ',
            patientNameT: '×©× ×”××˜×•×¤×œ',
            pictueT: '×ª××•× ×ª ×”×ª×¨×•×¤×”. (××•×¤×¦×™×•× ×œ×™)',
            picture: '×ª××•× ×”',
            quantity: '×›××•×ª',
            quantityA: '×× × ×œ×”×›× ×™×¡ ××¡×¤×¨ ×—×•×§×™ ×©×œ ×›××•×ª (×œ×“×•×’××”: 0.25, 1, 1.5, 4)',
            quantityT: '××¡×¤×¨ ×™×—×™×“×•×ª ×”×ª×¨×•×¤×” ×œ×§×—×ª ×‘×›×œ ×¤×¢×. (××•×¤×¦×™×•× ×œ×™)',
            save: '×©××•×¨',
            saveT: '×©×•××¨ ××ª ×”×©× ×•×¨×©×™××ª ×”×ª×¨×•×¤×•×ª ×‘××—×¡×•×Ÿ ×”××§×•××™ (×¢×•×’×™×•×ª)',
            timing: '××ª×™',
            As_needed: 'ğŸš¨ ×œ×¤×™ ×”×¦×•×¨×š',
            Morning: 'ğŸ“ ×‘×•×§×¨',
            Noon: 'â˜€ï¸ ×¦×”×¨×™×™×',
            Evening: 'ğŸŒ™ ×¢×¨×‘',
            timingA: '×× × ×œ×‘×—×•×¨ ×›×¢×ª ×–××Ÿ × ×˜×™×œ×ª ×”×ª×¨×•×¤×”',
            timingOrderA: '×¢×¨×š ×–××Ÿ ×œ× ×—×•×§×™. ×× × ×œ×”×©×ª××© ×‘: ×œ×¤×™ ×”×¦×•×¨×š, ×‘×•×§×¨, ×¦×”×¨×™×™× ××• ×¢×¨×‘',
            timingT: '××ª×™ × ×˜×™×œ×ª ×”×ª×¨×•×¤×”?',
            title: '×¨×©×™××ª ×”×ª×¨×•×¤×•×ª ×©×œ',
            xplainAppT: '×× ×”×œ ×¨×©×™××ª ×ª×¨×•×¤×•×ª ×¢×‘×•×¨ ××˜×•×¤×œ×™×',
        }
    };

    const rtlLanguages = ['ar', 'he'];
    const defaultLang = navigator.language.split('-')[0];//to avoid regional dialects
    let currentLang = defaultLang;
    console.log('defaultLang = ' + defaultLang);

    function t(key) {
        //console.log('translations[', currentLang, '][', key, ']=', translations[currentLang][key]);
        return translations[currentLang][key];
    }

    function handleLanguageChange(event) {
        currentLang = event.target.value;
        const isRTL = rtlLanguages.includes(currentLang);
        document.documentElement.setAttribute('lang', currentLang);
        document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
        // Update text position in drugName input label svg according to language direction
        const text_x = isRTL ? 240 : 40;
        document.getElementById('t-text').setAttribute('x', text_x);
        // Update text content in data-content containing elements.
        document.querySelectorAll('[data-content]').forEach(el => el.textContent = t(el.getAttribute('data-content')) || el.textContent);
        // Update titles (popup text) content if have data-title attribute.
        document.querySelectorAll('[data-title]').forEach(el => el.title = t(el.getAttribute('data-title')) || el.title);
        // Update all placeholders
        document.querySelectorAll('[data-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-placeholder')) || el.placeholder);
        // Function to populate the timing select based on selected language
        const selector = document.getElementById('timingSelect')
        const align = isRTL ? 'right-align' : 'left-align';
        const selectedTiming = selector.value;//**new^***
        console.log(`selector.id = ` + selector.id + `
        selectedTiming = ` + selectedTiming);
        selector.innerHTML = `<option value="" class=` + align + `>ğŸ•“</option>`;
        Object.keys(timingOrder).forEach(timingKey => {
            const option = document.createElement('option');
            option.value = timingKey;
            option.textContent = t(timingKey);
            option.classList.add(align);
            selector.appendChild(option);
        });
        selector.value = selectedTiming;//**new^***
    }

    // Add this function to your JavaScript
    function adjustInputWidth(input_element, type) {
        // Create a temporary span to measure text width
        const span = document.createElement('span');
        span.style.visibility = 'hidden';
        span.style.position = 'absolute';
        span.style.whiteSpace = 'pre';
        // Copy the input's font properties
        const inputStyle = window.getComputedStyle(input_element);
        span.style.font = inputStyle.font;
        span.style.padding = inputStyle.padding;

        document.body.appendChild(span);

        // Update width based on content
        span.textContent = input_element.value || input_element.placeholder || '';
        let contentWidth = span.offsetWidth;
        if (type == "select_type") {
            contentWidth += 60; // Add space for the dropdown arrow
        }
            console.log('select_type val. = ' + input_element.value, ' contentWidth = ' + contentWidth);

        // Convert em to pixels (assuming base font size)
        const fontSize = parseFloat(inputStyle.fontSize);
        const minWidth = 4 * fontSize;
        const maxWidth = 12 * fontSize;

        // Clamp width between min and max
        contentWidth = Math.max(minWidth, Math.min(maxWidth, contentWidth));

        input_element.style.width = `${contentWidth}px`;

        document.body.removeChild(span);
    }

    // Add event listeners to all inputs in the table
    document.querySelectorAll('.table-container input[type="text"]').forEach(input => {
        input.addEventListener('input', () => adjustInputWidth(input,"input_text_type"));
        // Initial adjustment
        adjustInputWidth(input);
    });

    document.querySelectorAll('.table-container select').forEach(select => {
        select.addEventListener('change', () => adjustInputWidth(select,"select_type"));
        // Initial adjustment
        adjustInputWidth(select);
    });

    function TitleLayoutPerfection() {
        function properSpaceWidth(titleE) { // calculate the proper width for the spacer element, to center the title
            if (!titleE) return {};
            const containerWidth = titleE.parentElement.offsetWidth;
            const titleWidth = titleE.offsetWidth;
            //let spacerWidth = document.getElementById('spacer');
            const langWidth = document.getElementById('languageSelector').offsetWidth;
            spacerWidthPx = Math.floor(Math.max(0, containerWidth * 0.5 - langWidth - titleWidth * 0.5)) + "px";
            //console.log('width= ' + width+ 'contWidth' + containerWidth); 
            return {
                Px: spacerWidthPx
            };
        };
        document.getElementById('spacer').style.width = properSpaceWidth(document.getElementsByClassName('app-title')[0]).Px;
        //console.log( properSpaceWidth(document.getElementById('spacer'))+'.spacerWidth =' + properSpaceWidth(document.getElementById('spacer')).spacerWidth);
    }

    function triggerInitialLanguage() {
        const selectElement = document.getElementById('language');
        // Get browser language, taking only the first two characters (e.g., 'en' from 'en-US')
        const browserLang = navigator.language.slice(0, 2);

        // Set the value if it exists in options
        if (Array.from(selectElement.options).some(option => option.value === browserLang)) {
            selectElement.value = browserLang;
        }

        // Create and dispatch change event
        const event = new Event('change');
        selectElement.dispatchEvent(event);
        TitleLayoutPerfection();
    }

    /* #endregion Translation */


    /* #region  Image Handler Modal */
    /*  #region Initialize img_handler global elements */
    const img_handler_mdl = document.getElementById('img_handler_modal');
    // Call img_handler once to set up the initial state
    const mdlCanvas = document.getElementById('mdlCanvas');
    mdlCanvas.style.width = "100%";
    const mdlCtx = mdlCanvas.getContext('2d');
    let clntX = null; // for mouse/touch position
    let clntY = null;
    let pictureIn = null;
    let scale; // will be used for scaling picture into canvas.
    let Wdth_to_Hght; // picture's ratio of width to height 
    const mdlThumbCnv = document.getElementById('mdlThumbCnv'); // thumbnail canvas in the image handling modal
    // Frame parameters
    let frame = {
        x: 0,
        y: 0,
        width: 100,
        height: 100,
        imgScale: 1,
        isDragging: false,
        DX: 0,
        DY: 0,
        startX: 0,
        startY: 0
    };
    const handlers = img_handler(false); // call img_handler to set up the initial state
    /* #endregion */

    function img_handler(show) {
        if (show) { img_handler_mdl.style.display = 'block'; } // show the modal
        frame.isDragging = false;
        function mdlCnvClntRect() { // get client canvas position and size           
            /*             console.log("mdlCanvas:", mdlCanvas, "  mdlCnvClntRect:", Object.fromEntries(
                            ['x', 'y', 'width', 'height']//, 'top', 'right', 'bottom', 'left']
                                .map(key => [key, Math.floor(mdlCanvas.getBoundingClientRect()[key])])
                        )
                        ); */
            return mdlCanvas.getBoundingClientRect();
        }
        //const pixelRatio = window.devicePixelRatio || 1; // may be needed for high resolution displays
        data_out();

        document.getElementById('imageInput').addEventListener('change', function (e) { // Load image from user's chosen file (via FileReader)
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result; // loading picture into img element
                    img.onload = function () { // setting picture into canvas size and drawing it (happens after loading)
                        pictureIn = img;
                        Wdth_to_Hght = pictureIn.naturalWidth / pictureIn.naturalHeight;
                        mdlCanvas.width = Math.sqrt(Wdth_to_Hght * 250000);
                        mdlCanvas.height = mdlCanvas.width / Wdth_to_Hght;
                        drawImage();
                        frame.imgScale = Math.min( // scaling the frame to the picture size
                            mdlCanvas.width / formThumbCnv.width,
                            mdlCanvas.height / formThumbCnv.height
                        );
                        frame.width = formThumbCnv.width * frame.imgScale;
                        frame.height = formThumbCnv.height * frame.imgScale;
                        centerFrame(); // centering the 'thumbnail selection' frame on the canvas.
                    };
                };
            }
        });

        function drawImage() {
            if (!pictureIn) return;
            mdlCtx.clearRect(0, 0, mdlCanvas.width, mdlCanvas.height);
            //context.drawImage(img, sx, sy, swidth, sheight, 
            //                  x, y, width, height)
            mdlCtx.drawImage(pictureIn, 0, 0, pictureIn.naturalWidth, pictureIn.naturalHeight,
                0, 0, mdlCanvas.width, mdlCanvas.height);
            data_out(); // shows parameters below the picture (debugging stage).
        }

        // shows parameters below the picture.
        function data_out() {
            let dataText = document.getElementById('data_text');
            dataText.innerHTML = "";
            if (pictureIn) {
                dataText.innerHTML += `     Pic    size = ` + pictureIn.naturalWidth + `x` + pictureIn.naturalHeight;
            }
            dataText.innerHTML += `
    Canvas size=`+ mdlCanvas.clientWidth + `x` + mdlCanvas.clientHeight;
            dataText.innerHTML += `
    Thumb size=`+ mdlThumbCnv.width + `x` + mdlThumbCnv.height;
            if (clntX == null) {
                dataText.innerHTML += `
     (no clntX)`;
            }
            else {
                dataText.innerHTML += `
    touch clientX,Y = `+ parseInt(clntX) + `, ` + parseInt(clntY);
            };
            /*            dataText.innerHTML += `
                pixelRatio=` + pixelRatio;*/
        }

        function centerFrame() { // Centering the frame on the canvas
            frame.x = (mdlCanvas.width - frame.width) / 2;
            frame.y = (mdlCanvas.height - frame.height) / 2;
            drawFrame();

        }

        function drawFrame() { // Drawing and presenting the frame on the canvas
            mdlCtx.shadowColor = 'rgba(20,220,500,0.7)';
            mdlCtx.shadowBlur = 18;
            mdlCtx.strokeStyle = `rgba(220,520,700,0.3)`;
            mdlCtx.strokeRect(frame.x - 25, frame.y - 25, frame.width + 50, frame.height + 50);
            // Reset shadow for future drawings
            mdlCtx.shadowColor = 'transparent';
            mdlCtx.shadowBlur = 0;
            mdlCtx.shadowOffsetX = 0;
            mdlCtx.shadowOffsetY = 0;
            // Draw semitransparent rectangle around the frame. Gradient used to trim corners
            const grd = mdlCtx.createRadialGradient(             //   (x0, y0, r0,           x1, y1, r1)
                (frame.x + frame.width / 2), (frame.y + frame.height / 2), Math.sqrt(((50 + frame.width) ** 2 + (50 + frame.height) ** 2)) / 2,
                (frame.x + frame.width / 2), (frame.y + frame.height / 2), Math.sqrt(((51 + frame.width) ** 2 + (51 + frame.height) ** 2)) / 2
            );
            grd.addColorStop(0, `rgba(220,520,700,0.8)`);
            grd.addColorStop(1, `rgba(220,520,700,0)`);
            mdlCtx.lineWidth = 30;
            mdlCtx.strokeStyle = grd;
            mdlCtx.strokeRect(frame.x - 13, frame.y - 13, frame.width + 26, frame.height + 26);
            // Draw the main frame
            mdlCtx.strokeStyle = '#0066cc';
            mdlCtx.lineWidth = 4;
            mdlCtx.strokeRect(frame.x, frame.y, frame.width, frame.height);
        }

        //#region Frame dragging Events:
        // Mouse events
        mdlCanvas.addEventListener('mousedown', (e) => {
            clntXY(e);
            startDragging();
        });
        document.addEventListener('mousemove', (e) => {
            clntXY(e);
            drag();
        });
        document.addEventListener('mouseup', stopDragging);

        // Touch events with specific targeting. FUTURE PLAN: TO FUSE IT WITH THE TOUCHMOVE
        mdlCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            clntXY(e.touches[0]);
            startDragging();
        });

        mdlCanvas.addEventListener('touchmove', function (e) {
            e.preventDefault();
            clntXY(e.touches[0]);
            drag();
        })

        mdlCanvas.addEventListener('touchend', function (e) {
            frame.isDragging = false;
        }, false);

        mdlCanvas.addEventListener('touchcancel', function (e) {
            frame.isDragging = false;
        }, false);

        function clntXY(e_) {
            clntX = e_.clientX;
            clntY = e_.clientY;
        }
        /* #endregion */

        function startDragging() {
            if (!pictureIn) return;
            //update_mcc_rect();
            frame.startX = clntX - mdlCnvClntRect().left;
            frame.startY = clntY - mdlCnvClntRect().top;
            // Convert click coordinates to canvas coordinates
            const [CScaleX, CScaleY] = CanvasToClientXYScales();
            const canvasX = frame.startX * CScaleX;
            const canvasY = frame.startY * CScaleY;
            const insideX = canvasX >= frame.x && canvasX <= frame.x + frame.width;
            const insideY = canvasY >= frame.y && canvasY <= frame.y + frame.height;

            if (insideX && insideY) {
                frame.isDragging = true;
                // Calculate offset from frame edge, not rect.x/y
                frame.DX = canvasX - frame.x;
                frame.DY = canvasY - frame.y;
            }
        }

        let lastFrameRequest = null;

        function CanvasToClientXYScales() {
            return [mdlCanvas.width / mdlCnvClntRect().width, mdlCanvas.height / mdlCnvClntRect().height];
        }

        function drag() { // frame dragging function
            if (!frame.isDragging) return;

            // Cancel any pending frame request
            if (lastFrameRequest) {
                cancelAnimationFrame(lastFrameRequest);
            }

            // Schedule the update for the next animation frame (not to confuse with the drag and choose frame)
            lastFrameRequest = requestAnimationFrame(() => {
                //update_mcc_rect();
                const [CScaleX, CScaleY] = CanvasToClientXYScales();
                const canvasX = (clntX - mdlCnvClntRect().left) * CScaleX;
                const canvasY = (clntY - mdlCnvClntRect().top) * CScaleY;
                frame.x = canvasX - frame.DX;
                frame.y = canvasY - frame.DY;
                // Constrain to image boundaries
                frame.x = Math.max(0, Math.min(frame.x, mdlCanvas.width - frame.width));
                frame.y = Math.max(0, Math.min(frame.y, mdlCanvas.height - frame.height));
                drawImage();
                drawFrame();
            });
        }
        function stopDragging() {
            frame.isDragging = false;
            if (lastFrameRequest) {
                cancelAnimationFrame(lastFrameRequest);
                lastFrameRequest = null;
            }
        }

        document.getElementById('frame_to_thumb').addEventListener('click', async () => {
            await handlers.frame_to_thumb();
        });
        async function frame_to_thumb() {
            mdlCtx.save();
            drawImage();
            let { mdlThumbUrlData, mdlThumbScale } = resizeCanvasImage(mdlCanvas);
            mdlCtx.restore();
            drawFrame();
            document.getElementById('mdlThumbCnv').style.visibility = 'visible';
            //         await new Promise(resolve => setTimeout(resolve, 100)); // Wait for 100ms
            const img = new Image();
            img.src = mdlThumbUrlData;
            await new Promise((resolve) => {
                //alert('mdlThumbUrlData=' + mdlThumbUrlData);
                img.onload = function () {
                    mdlThumbCnv.style.width = mdlCanvas.style.width;
                    mdlThumbCnv.style.height = mdlThumbCnv.offsetWidth * frame.height / frame.width + 'px';
                    thmbScale = img.width / mdlCanvas.width;
                    mdlThumbCnv.getContext('2d').clearRect(0, 0, mdlThumbCnv.width, mdlThumbCnv.height);
                    mdlThumbCnv.getContext('2d').drawImage(
                        img, frame.x * thmbScale, frame.y * thmbScale, frame.width * thmbScale, frame.height * thmbScale, 0, 0, mdlThumbCnv.width, mdlThumbCnv.height);
                    //context.drawImage(img, sx, sy, swidth, sheight, 
                    //                  x, y, width, height)
                    resolve();
                }
            });
            return img.src;
        }
        function resizeCanvasImage(sourceCanvas) {
            // Start with original dimensions
            let targetWidth = sourceCanvas.width;
            let targetHeight = sourceCanvas.height;

            // Create temporary canvas for resizing
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // Binary search for the right size
            let quality = 0.7;  // JPEG quality
            let minScale = 0.1;
            let maxScale = 1.0;
            let tmpScale = 0.5;
            let bestSize = Infinity;
            let bestData = null;
            let iterations = 0;
            let size = 0;
            let tmpDataUrl = null;
            const TARGET_SIZE = 10000; // Target ~10KB
            const MAX_ITERATIONS = 10;

            while (iterations < MAX_ITERATIONS) {
                tmpScale = (minScale + maxScale) / 2;
                tempCanvas.width = targetWidth * tmpScale;
                tempCanvas.height = targetHeight * tmpScale;
                // Draw resized image
                tempCtx.drawImage(sourceCanvas, 0, 0, tempCanvas.width, tempCanvas.height);
                // Convert to JPEG data URL
                tmpDataUrl = tempCanvas.toDataURL('image/jpeg', quality);
                size = Math.floor(tmpDataUrl.length); //* 3 / 4 =Approximate base64 size
                if (Math.abs(size - TARGET_SIZE) < Math.abs(bestSize - TARGET_SIZE)) {
                    bestSize = size;
                    bestData = tmpDataUrl;
                }
                if (Math.abs(size - TARGET_SIZE) < TARGET_SIZE * 0.1) {
                    break; // Within 10% of target
                }
                if (size > TARGET_SIZE) {
                    maxScale = tmpScale;
                } else {
                    minScale = tmpScale;
                }
                iterations++;
            }
            return { mdlThumbUrlData: tmpDataUrl, mdlThumbScale: tmpScale }; // returns resized image data URL and scale
        } // end of resizeCanvasImage
        return {
            frame_to_thumb: frame_to_thumb
        } //end of img_handler
    }
    // Close the img_handler modal and save the thumbnail
    document.getElementById('ok_thumb').addEventListener('click', async function () {  // ?? save the thumbnail thumbDataUrl
        // Dispatch/Trigger/Fire the frame_to_thumb event
        closeImgHandlerModal();
        await handlers.frame_to_thumb();



        // img_handler().frame_to_thumb();
        formThumbCtx.clearRect(0, 0, formThumbCnv.width, formThumbCnv.height);
        formThumbCtx.drawImage(mdlThumbCnv, 0, 0, formThumbCnv.width, formThumbCnv.height);

    });
    // Close the img_handler modal
    function closeImgHandlerModal() {
        document.getElementById('img_handler_modal').style.display = 'none';
    }
    /* #endregion Image Handler Modal */

    /* #region Initialize */
    console.log("Script re/start");// js start point
    // Ensure width of patient-controls is same as form
    document.addEventListener('DOMContentLoaded', function () {
        triggerInitialLanguage();
        updateTable();
        init();
    });
    window.addEventListener('resize', function () {
        init();
    });
    function init() {
        TitleLayoutPerfection();
        ensurePatientControlsWidthLessThanTable();
    }
    function ensurePatientControlsWidthLessThanTable() {
        const table = document.querySelector('.table-container');
        const patientControls = document.querySelector('.patient-controls');
        if (table && patientControls) {
            const tableWidth = table.offsetWidth;
            //console.log("tableWidth = " + tableWidth);
            patientControls.style.maxWidth = `${tableWidth}px`;
        }
    };
    /* #endregion Initialize */
</script>

</html>